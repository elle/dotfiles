# require "autotest/growl"
# require "autotest/fsevent"
# require "autotest/restart"
# require "autotest/redgreen"
require 'autotest/growl'
require 'autotest/timestamp'

Autotest.add_hook :initialize do |autotest|
  %w{.git .svn .hg .DS_Store ._* vendor tmp log doc}.each do |exception|
    autotest.add_exception(exception)
  end
end

Autotest::Growl::clear_terminal = false
Autotest::Growl::hide_label = true
Autotest::Growl::one_notification_per_run = true
Autotest::Growl::sticky_failure_notifications = true # Make Failure and Error Notifications Sticky
Autotest::Growl::show_modified_files = false

# Ref: http://wincent.com/knowledge-base/Setting_up_autotest_to_use_Growl
module Autotest::Growl

 def self.growl title, msg, img, pri=0, sticky=""
   system "growlnotify -n autotest -d #{title} --image #{img} -p #{pri} -m #{msg.inspect} #{title} #{sticky}"
 end

 Autotest.add_hook :ran_command do |at|
  unless at.results.empty?
    output = at.results.last.slice(/(\d+)\s.*(?:examples|assertions)?,\s(\d+)\s.*failures?/)
    if output =~ /[1-9]\sfailures?/
      growl "FAIL", "#{output}", "~/bin/autotest/fail.png", 2, "-s"
    else
      growl "PASS", "#{output}", "~/bin/autotest/pass.png"
    end
  end
 end

end
